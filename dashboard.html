<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles/dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <title>Admin Dashboard</title>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="logo-container">
            <img src="resources/images/logo.png" alt="PaRepair Logo">
            <h2>PaRepair Admin</h2>
        </div>
        <button class="toggle-btn" id="toggle-btn">
            <i class="fas fa-bars"></i>
        </button>
        <hr class="divider">
        <nav class="sidebar-menu">
            <ul>
                <li><a href="#dashboard"><i class="fas fa-tachometer-alt"></i><span> Dashboard</span></a></li>
                <li><a href="#appointments"><i class="fas fa-calendar-check"></i><span> Appointments</span></a></li>
                <li><a href="#users"><i class="fas fa-users"></i><span> Users</span></a></li>
                <li><a href="#settings"><i class="fas fa-cog"></i><span> Settings</span></a></li>
                <li><a href="#reports"><i class="fas fa-chart-line"></i><span> Reports</span></a></li>
                <li><a id="logout-button"><i class="fas fa-sign-out-alt"></i><span> Logout</span></a></li>
            </ul>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        <header class="dashboard-header">
          <div class="welcome-message">
            <h1>Welcome, Admin!</h1>
            <p>Hereâ€™s an overview of your dashboard</p>
          </div>
          <div class="header-right">    
            <input type="text" placeholder="Search..." class="search-bar">
            <div class="profile">
              <img src="resources/images/logo.png" alt="Admin Profile">
            </div>
          </div>
        </header>

        <section class="card-container">
            <div class="user-card">
              <i class="fas fa-users user-icon"></i>
              <div class="card-content">
                <h2>Total Users</h2>
                <p id="userCount">0</p> 
              </div>
            </div>
            <div class="user-card">
                <i class="fas fa-calendar-check user-icon"></i>
                <div class="card-content">
                  <h2>Pending Appointments</h2>
                  <p id="appointmentCount">0</p> 
                </div>
              </div>
              <div class="user-card">
                <i class="fas fa-file-invoice user-icon"></i>
                <div class="card-content">
                  <h2>Reports</h2>
                  <p id="reportCount">0</p> 
                </div>
              </div>
              <div class="user-card">
                <i class="fas fa-tools user-icon"></i>
                <div class="card-content">
                  <h2>Services Available</h2>
                  <p id="serviceCount">0</p> 
                </div>
              </div>
        </section>

        <!-- Table -->
        <section class="table-container">
          <h2>Recent Appointments</h2>
          <table class="appointments-table">
              <thead>
                  <tr>
                      <th>#</th>
                      <th>Client Name</th>
                      <th>Service Provider</th>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Status</th>
                  </tr>
              </thead>
              <tbody id="appointments-tbody">
              </tbody>
          </table>
      </section>
      

         <!-- Chart -->

         <div class="chart-container">
            <h2>User Statistics</h2>
            <canvas id="myChart"></canvas>
        </div>
        
    </main>
  </div>

  

  <script src="resources/js/dashboard.js"></script>
  <script src="chart.js"></script>
  <script type="module">
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyBHJ025X5bX0-nhwvbq5CTNxCtRyvGYJE4",
      authDomain: "parepair-63325.firebaseapp.com",
      projectId: "parepair-63325",
      storageBucket: "parepair-63325.appspot.com",
      messagingSenderId: "269243614085",
      appId: "1:269243614085:web:af243ba37f8f12f2d1faec"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app); // Initialize Firestore
  
    // Function to count total users
    async function countTotalUsers() {
      try {
        const userCollection = collection(db, "users"); // Reference to the 'users' collection
        const userSnapshot = await getDocs(userCollection); // Get all documents in the collection
        const userCount = userSnapshot.size; // Count the number of documents
        document.getElementById("userCount").textContent = userCount; // Update the user count in the HTML
      } catch (error) {
        console.error("Error counting users:", error.message);
      }
    }
  
    // Function to fetch user data based on UID
    async function fetchUserData(userId) {
      try {
        const userDocRef = doc(db, "users", userId);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
          document.getElementById("user-data").innerHTML = `<p>User Data: ${JSON.stringify(userDoc.data())}</p>`;
        } else {
          console.log("No such document!");
        }
      } catch (error) {
        console.error("Error retrieving data from Firestore:", error.message);
      }
    }
  
    // Function to write or update user data
    async function writeUserData(userId, data) {
      try {
        const userDocRef = doc(db, "users", userId);
        await setDoc(userDocRef, data, { merge: true }); // Merge to avoid overwriting existing data
        console.log("User data written successfully");
      } catch (error) {
        console.error("Error writing data to Firestore:", error.message);
      }
    }
  
   // Function to fetch appointments and populate the table
async function fetchAppointments() {
  try {
    const appointmentsCollection = collection(db, "appointments"); // Reference to the 'appointments' collection
    const appointmentsSnapshot = await getDocs(appointmentsCollection); // Get all documents in the collection

    const appointmentsTbody = document.getElementById("appointments-tbody");
    appointmentsTbody.innerHTML = ""; // Clear previous data

    let rowCount = 1; // Initialize the counter for row numbers

    appointmentsSnapshot.forEach((doc) => {
      const appointment = doc.data(); // Get the data for each appointment
      const row = document.createElement("tr"); // Create a new row for each appointment
      row.innerHTML = `
        <td>${rowCount++}</td> <!-- Increment the counter -->
        <td>${appointment.clientFullName}</td>
        <td>${appointment.serviceProviderJob}</td>
        <td>${appointment.selectedDate}</td>
        <td>${appointment.selectedTime}</td>
        <td>${appointment.bookingStatus}</td>
      `;
      appointmentsTbody.appendChild(row); // Append the row to the table body
    });
  } catch (error) {
    console.error("Error fetching appointments:", error.message);
  }
}

    // Check if user is logged in and fetch their data
    auth.onAuthStateChanged((user) => {
      if (user) {
        const userId = user.uid;
        fetchUserData(userId); // Fetch user data
        countTotalUsers(); // Count total users
        fetchAppointments(); // Fetch appointments data and populate the table
  
        // Example: Write user data (this could be called based on some user action)
        writeUserData(userId, { lastLogin: new Date().toISOString() });
      } else {
        // No user is signed in, redirect to login
        window.location.href = "index.html";
      }
    });
  
    // Log out function
    document.getElementById("logout-button").addEventListener("click", async () => {
      await signOut(auth);
      sessionStorage.removeItem("isLoggedIn");
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
