<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles/dashboard.css" />
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <title>Messages</title>
  </head>
  <body>
    <div class="dashboard-container">
      <aside class="sidebar">
        <div class="logo-container">
          <img src="resources/images/logo.png" alt="PaRepair Logo" />
          <h2>PaRepair Admin</h2>
        </div>
        <hr class="divider" />
        <nav class="sidebar-menu">
          <ul>
            <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="messages.html"><i class="fas fa-envelope"></i> Messages</a></li>
            <li><a href="appointments.html"><i class="fas fa-calendar-check"></i> Appointments</a></li>
            <li><a href="users.html"><i class="fas fa-users"></i> Users</a></li>
            <li><a href="applying_sv.html"><i class="fas fa-clipboard-list"></i> Apply for Service</a></li>
            <li><a id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
          </ul>
        </nav>
      </aside>

      <main class="main-content">
        <header class="dashboard-header">
          <h1>Messages</h1>
          <p>View and respond to messages</p>
        </header>

        <div class="chat-container">
          <!-- User List -->
          <div class="user-list">
            <h3>Users</h3>
            <ul id="userList"></ul>
          </div>

          <!-- Chatbox -->
          <div class="chat-box">
            <h2 id="chatTitle">Select a User</h2>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="message-input">
              <textarea id="messageInput" placeholder="Type your message..." disabled></textarea>
              <button id="sendMessage" disabled>Send</button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script type="module">
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy, addDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    
        // üî• Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBHJ025X5bX0-nhwvbq5CTNxCtRyvGYJE4",
            authDomain: "parepair-63325.firebaseapp.com",
            projectId: "parepair-63325",
            storageBucket: "parepair-63325.appspot.com",
            messagingSenderId: "269243614085",
            appId: "1:269243614085:web:af243ba37f8f12f2d1faec",
        };
    
        // üî• Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
    
        let selectedSenderId = null;
        let selectedFullName = "User";
    
        // üìå Load Users in Chat List with Full Names
        function loadUserList() {
            const userListContainer = document.getElementById("userList");
    
            onSnapshot(collection(db, "admin_chats"), async (snapshot) => {
                const senderIds = new Set();
                const userFullNames = {};
    
                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();
                    if (data.senderId) senderIds.add(data.senderId);
                }
    
                userListContainer.innerHTML = "";
    
                for (const senderId of senderIds) {
                    const fullName = await getFullName(senderId);
                    userFullNames[senderId] = fullName;
    
                    const li = document.createElement("li");
                    li.textContent = fullName;
                    li.dataset.senderId = senderId;
                    li.addEventListener("click", () => selectUser(senderId, fullName));
                    userListContainer.appendChild(li);
                }
    
                if (!selectedSenderId && senderIds.size > 0) {
                    selectedSenderId = [...senderIds][0];
                    selectedFullName = userFullNames[selectedSenderId];
                    selectUser(selectedSenderId, selectedFullName);
                }
            });
        }
    
        // üéØ Select User & Listen for Real-Time Messages
        function selectUser(senderId, fullName) {
            selectedSenderId = senderId;
            selectedFullName = fullName;
            document.getElementById("chatTitle").textContent = `Chat with ${fullName}`;
            document.getElementById("messageInput").disabled = false;
            document.getElementById("sendMessage").disabled = false;
    
            listenForNewMessages();
        }
    
        // üîÑ Listen for New Messages in Real-time
        function listenForNewMessages() {
            const chatMessagesContainer = document.getElementById("chatMessages");
            chatMessagesContainer.innerHTML = "";
    
            const q = query(
                collection(db, "admin_chats"),
                where("senderId", "==", selectedSenderId),
                orderBy("timestamp", "asc")
            );
    
            // üì° Firestore Listener for New Messages
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const messageData = change.doc.data();
                        if (!messageData.message || !messageData.timestamp) return;
    
                        const messageDiv = document.createElement("div");
                        messageDiv.className = messageData.isAdmin ? "message sent" : "message received";
                        const timestamp = messageData.timestamp.toDate().toLocaleTimeString();
    
                        messageDiv.innerHTML = `${messageData.message} <br><small>${timestamp}</small>`;
                        chatMessagesContainer.appendChild(messageDiv);
                    }
                });
    
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Auto-scroll
            });
        }
    
        // ‚úâÔ∏è Send Message & Display Immediately
        document.getElementById("sendMessage").addEventListener("click", async () => {
            const messageInput = document.getElementById("messageInput");
            const chatMessagesContainer = document.getElementById("chatMessages");
    
            if (!messageInput.value.trim() || !selectedSenderId) return;
    
            // Show Message Instantly (UI update before Firestore save)
            const messageDiv = document.createElement("div");
            messageDiv.className = "message sent";
            const timestamp = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `${messageInput.value.trim()} <br><small>${timestamp}</small>`;
            chatMessagesContainer.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    
            // Save Message to Firestore
            await addDoc(collection(db, "admin_chats"), {
                senderId: selectedSenderId,
                message: messageInput.value.trim(),
                isAdmin: true,
                timestamp: serverTimestamp(),
            });
    
            messageInput.value = "";
        });
    
        // üîç Get Full Name from Firestore Users Collection
        async function getFullName(senderId) {
            const userDoc = await getDoc(doc(db, "users", senderId));
            if (userDoc.exists()) {
                return userDoc.data().fullName || `User ${senderId}`;
            }
            return `User ${senderId}`;
        }
    
        document.addEventListener("DOMContentLoaded", loadUserList);
    </script>
    
  </body>
</html>